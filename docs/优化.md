好的，我们来对照 `server.js` 和 `knowledge_graph.js` 中的知识图谱（KG）相关 API 实现，检查并完善 `KnowledgeGraph.md` 文档。

**分析结果:**

1.  **文档中缺少（但在代码中存在）的 API：**
    *   `GET /api/kg/relations/:source/:target/:type/properties`: 用于获取特定关系（由源、目标、类型唯一标识）的属性。文档中没有单独列出此 API。
    *   `PUT /api/kg/entity-properties`: 用于更新（完全替换）指定实体的 `properties` 字段。文档中没有单独列出此 API。

2.  **文档与代码需要对齐或优化的 API：**
    *   **概念部分:**
        *   实体示例中使用了 `entityType`，但代码实现（`knowledge_graph.js` 的 `createEntities` 等方法）和 API 交互中实际使用的是 `type` 字段。应统一为 `type`。
        *   关系示例中使用了 `from` 和 `to`，但代码实现和 API 交互中实际使用的是 `source` 和 `target`。应统一为 `source` 和 `target`。
    *   **API 3: 创建关系 (`POST /api/kg/relations`)**: 文档描述基本正确，但可以更明确地说明 `properties` 是可选的，并且是键值对对象。
    *   **API 4: 添加观察 (`POST /api/kg/observations`)**: 代码实现会检查观察内容的重复性。如果内容已存在，不会重复添加，而是返回 `status: 'exists'`。文档应补充说明这一点。
    *   **API 12: 更新特定观察项 (`PUT /api/kg/observations`)**: 代码实现要求在请求体 `updates` 数组的每个对象中包含 `entityName`, `index`, `content`。文档也应明确这些必需字段。
    *   **API 16: 更新关系属性 (`PUT /api/kg/relation-properties`)**: 代码实现是完全替换 `properties` 对象。文档应明确这一点。
    *   **API 17: 更新实体信息 (`PUT /api/kg/entity`)**: 代码实现中，此 API **同时** 承担了 **更新实体类型** 和 **实体（如果提供了 `oldName` 且与 `name` 不同）** 的功能。文档需要明确说明这个双重用途，并更新请求体示例。
    *   **API 18: 更新关系信息 (`PUT /api/kg/relation`)**: 代码实现的核心功能是 **更改关系类型**。它通过删除旧类型的关系并创建新类型的关系（同时保留属性）来实现。文档需要更精确地描述这个行为，而不是泛泛的“更新关系信息”。

3.  **文档描述准确且与代码一致的 API：**
    *   API 1: `GET /api/kg/graph`
    *   API 2: `POST /api/kg/entities` (注意 `type` 字段)
    *   API 5: `DELETE /api/kg/entities`
    *   API 6: `DELETE /api/kg/observations`
    *   API 7: `DELETE /api/kg/relations`
    *   API 8: `GET /api/kg/search`
    *   API 9: `GET /api/kg/nodes`
    *   API 10: `POST /api/kg/load-graph`
    *   API 11: `GET /api/kg/graph-files`
    *   API 13: `PUT /api/kg/entity-observations`
    *   API 14: `POST /api/kg/create-graph`
    *   API 15: `DELETE /api/kg/delete-graph`

**完善后的文档（修订版）：**

(这里只展示需要修改和新增的部分，其余部分保持不变，并重新编号)

---

# 知识图谱 API 文档 (修订版)

知识图谱（Knowledge Graph）是一种语义网络，用于表示各种实体之间的关系及其属性。本API提供了创建、管理和查询知识图谱的功能。
知识图谱端口:3000

## 初始化知识图谱

(此部分描述准确，保持不变)
...

## Knowledge Graph Memory Server (核心概念)

...

**实体 (Entities)**
实体是知识图谱中的主要节点。每个实体具有：

*   一个唯一的 `name` (名称/标识符)
*   一个 `type` (实体类型，例如："person", "organization", "event")
*   一个 `observations` 列表 (关于该实体的观察记录)
*   一个 `properties` 对象 (键值对形式的附加属性)

示例:
```json
{
  "name": "张三",
  "type": "人物",
  "observations": [
    { "content": "精通西班牙语", "timestamp": "...", "source": "..." }
  ],
  "properties": { "age": 30 }
}
```

**关系 (Relations)**
关系定义了实体之间的有向连接。它们描述了实体如何相互作用或关联。

*   `source`: 源实体名称
*   `target`: 目标实体名称
*   `type`: 关系类型 (例如: "works_at", "朋友")
*   `properties`: 关系的附加属性 (可选的键值对对象)

示例:
```json
{
  "source": "张三",
  "target": "某公司",
  "type": "任职于",
  "properties": { "startDate": "2022-01-10" }
}
```

**观察 (Observations)**
观察是关于实体的离散信息片段。它们：

*   存储为对象，至少包含 `content` (字符串内容)，通常还有 `timestamp` 和 `source`
*   附加到特定的实体
*   可以独立添加或删除
*   应尽可能原子化 (每个观察记录一个事实)

示例:
```json
{
  "entityName": "张三",
  "observations": [
    { "content": "精通西班牙语", "timestamp": "...", "source": "..." },
    { "content": "2019年毕业", "timestamp": "...", "source": "..." },
    { "content": "倾向于上午开会", "timestamp": "...", "source": "..." }
  ]
}
```

## API 端点

### 1. 获取完整知识图谱

```
GET /api/kg/graph
```

(描述不变)
...

### 2. 创建实体

```
POST /api/kg/entities
```

创建一个或多个新实体。

**请求体：**

```json
{
  "entities": [
    {
      "name": "实体名称", // 必需
      "type": "实体类型", // 必需
      "observations": [ // 可选，观察对象数组
        { "content": "观察内容1", "timestamp": "...", "source": "..." }
      ],
      "properties": { // 可选，键值对属性
        "key1": "value1"
      },
      "overwrite": false // 可选，默认为false
    }
  ]
}
```

**参数说明：**
- `name`：实体名称（必需）
- `type`：实体类型（必需）
- `observations`：关于该实体的观察对象数组（可选）
- `properties`：实体的附加属性对象（可选）
- `overwrite`：如果为 `true` 且同名实体已存在，则更新该实体；否则（或为 `false`）仅返回 `status: 'exists'`。（可选，默认为 `false`）

**返回示例：** (不变)
...

### 3. 创建关系

```
POST /api/kg/relations
```

创建实体之间的关系。

**请求体：**

```json
{
  "relations": [
    {
      "source": "源实体名称", // 必需
      "target": "目标实体名称", // 必需
      "type": "关系类型", // 必需
      "properties": { // 可选，键值对属性
        "key1": "value1",
        "key2": 123
      },
      "overwrite": false // 可选，默认为false
    }
  ]
}
```

**属性字段说明 (`properties`)：** (不变)
...

**参数说明：**
- `source`：源实体名称（必需）
- `target`：目标实体名称（必需）
- `type`：关系类型（必需）
- `properties`：关系的附加属性对象（可选）
- `overwrite`：如果为 `true` 且具有相同 `source`, `target`, `type` 的关系已存在，则更新该关系（特别是 `properties`）；否则（或为 `false`）仅返回 `status: 'exists'`。（可选，默认为 `false`）

**返回示例：** (不变)
...

### 4. 添加观察

```
POST /api/kg/observations
```

向已有实体添加观察项。**注意：如果具有完全相同 `content` 的观察项已存在于该实体中，则不会重复添加，并返回 `status: 'exists'`。**

**请求体：**

```json
{
  "observations": [
    {
      "entityName": "实体名称", // 必需
      "content": "观察内容", // 必需
      "timestamp": "2023-04-09T08:30:00.000Z", // 可选，默认为当前时间
      "source": "用户" // 可选，默认为 "user"
    }
  ]
}
```

**参数说明：**
- `entityName`：实体名称（必需）
- `content`：观察内容（必需）
- `timestamp`：时间戳（可选）
- `source`：数据来源（可选）

**返回示例：** (不变，但需注意 `status` 可能为 `'exists'`)
...

### 5. 更新实体信息 (类型更新与重命名)

```
PUT /api/kg/entity
```

更新实体的基本信息，**包括更新实体类型和/或重命名实体**。

**请求体：**

```json
{
  "name": "新实体名称", // 必需，即使不重命名也要提供
  "type": "新实体类型", // 必需，即使不改变类型也要提供
  "oldName": "原实体名称" // 可选，仅在需要重命名时提供
}
```

**行为说明：**
- **仅更新类型**：提供 `name` (与原名称相同) 和新的 `type`，不提供 `oldName` 或 `oldName` 与 `name` 相同。
- **重命名实体（并可能更新类型）**：提供新的 `name`，新的 `type`，以及与 `name` 不同的 `oldName`。系统会找到 `oldName` 对应的实体，将其名称改为 `name`，类型改为 `type`，并更新所有相关关系中的引用。

**参数说明：**
- `name`：新的实体名称（必需）
- `type`：新的实体类型（必需）
- `oldName`：原实体名称（**仅当需要重命名时提供且必须与 `name` 不同**）

**返回示例：**

```json
{
  "success": true,
  "message": "实体更新/重命名成功" // 或具体的错误信息
}
```

### 6. 更新实体属性

```
PUT /api/kg/entity-properties
```

**完全替换**指定实体的 `properties` 对象。如果只想添加或修改部分属性，需要先获取现有属性，合并后再调用此API。

**请求体：**

```json
{
  "entityName": "实体名称", // 必需
  "properties": { // 必需，新的完整属性对象
    "key1": "new_value1",
    "new_key": "value2"
  }
}
```

**参数说明：**
- `entityName`：要更新属性的实体名称（必需）。
- `properties`：新的完整属性对象（必需）。旧的 `properties` 对象将被完全覆盖。如果传入空对象 `{}`，则会清空该实体的所有属性。

**返回示例：**

```json
{
  "success": true,
  "data": {
    "entityName": "实体名称",
    "status": "properties_updated"
  }
}
```

### 7. 更新关系类型

```
PUT /api/kg/relation
```

更改现有关系的**类型**。此操作会保留关系的原有属性。**内部实现是通过删除原关系并创建具有新类型和相同属性的新关系来完成的。**

**请求体：**

```json
{
  "source": "源实体名称", // 必需
  "target": "目标实体名称", // 必需
  "type": "新关系类型", // 必需
  "originalType": "原关系类型" // 必需，用于定位要修改的关系
}
```

**参数说明：**
- `source`：源实体名称（必需）
- `target`：目标实体名称（必需）
- `type`：新的关系类型（必需）
- `originalType`：原关系类型（必需）

**返回示例：**

```json
{
  "success": true,
  "message": "关系类型更新成功" // 或具体的错误信息
}
```

### 8. 更新关系属性

```
PUT /api/kg/relation-properties
```

**完全替换**特定关系的 `properties` 对象。

**请求体：**

```json
{
  "relation": {
    "source": "源实体名称", // 必需
    "target": "目标实体名称", // 必需
    "type": "关系类型", // 必需
    "properties": { // 必需，新的完整属性对象
      "key1": "new_value1",
      "new_key": "value2"
    }
  }
}
```

**参数说明：**
- `source`：源实体名称（必需）
- `target`：目标实体名称（必需）
- `type`：关系类型（必需）
- `properties`：新的完整属性对象（必需）。将完全替换该关系现有的属性。

**返回示例：**

```json
{
  "success": true,
  "message": "关系属性更新成功"
}
```

### 9. 更新特定观察项

```
PUT /api/kg/observations
```

更新实体中指定索引位置的观察项内容、时间戳或来源。

**请求体：**

```json
{
  "updates": [
    {
      "entityName": "实体名称", // 必需
      "index": 0, // 必需，要更新的观察项索引
      "content": "新的观察内容", // 必需
      "timestamp": "2023-04-10T10:00:00.000Z", // 可选，更新时间戳
      "source": "system" // 可选，更新来源
    }
  ]
}
```

**参数说明：**
- `entityName`：实体名称（必需）
- `index`：要更新的观察项索引（必需）
- `content`：新的观察内容（必需）
- `timestamp`：新的时间戳（可选）
- `source`：新的数据来源（可选）

**返回示例：** (不变)
...

### 10. 更新实体的所有观察项

```
PUT /api/kg/entity-observations
```

(描述不变)
...

### 11. 删除实体

```
DELETE /api/kg/entities
```

(描述不变)
...

### 12. 删除观察

```
DELETE /api/kg/observations
```

(描述不变)
...

### 13. 删除关系

```
DELETE /api/kg/relations
```

(描述不变)
...

### 14. 删除知识图谱文件

```
DELETE /api/kg/delete-graph
```

(描述不变)
...

### 15. 获取关系属性

```
GET /api/kg/relations/:source/:target/:type/properties
```

获取由源实体、目标实体和关系类型唯一确定的单个关系的属性。

**路径参数：**
- `:source`: 源实体名称
- `:target`: 目标实体名称
- `:type`: 关系类型

**返回示例：**

```json
// 如果关系存在且有属性
{
  "success": true,
  "data": {
    "key1": "value1",
    "startDate": "2022-01-10"
  }
}

// 如果关系存在但没有属性
{
  "success": true,
  "data": {}
}

// 如果关系不存在
{
  "success": true,
  "data": null // 或根据具体实现返回 {} 或 404 错误
}
```
*注意：代码中 `KnowledgeGraph.js` 的 `getRelationProperties` 返回 `null`，但 `server.js` 中的路由处理直接返回 `relation.properties`，如果 `relation` 未找到，`relation` 为 `undefined`，因此返回 `{}` 更符合实际情况。*

### 16. 搜索节点

```
GET /api/kg/search?query=关键词
```

(描述不变)
...

### 17. 查找特定节点

```
GET /api/kg/nodes?names=实体1,实体2
```

(描述不变)
...

### 18. 加载知识图谱文件

```
POST /api/kg/load-graph
```

(描述不变)
...

### 19. 获取知识图谱文件列表

```
GET /api/kg/graph-files
```

(描述不变)
...

### 20. 创建新的知识图谱文件

```
POST /api/kg/create-graph
```

(描述不变)
...

## 错误处理

(描述不变)
...

---

**总结:**
主要修改包括：
*   新增了 `GET /api/kg/relations/:source/:target/:type/properties` 和 `PUT /api/kg/entity-properties` 两个 API 的文档。
*   修正了概念部分关于 `type` vs `entityType` 和 `source`/`target` vs `from`/`to` 的术语不一致问题。
*   明确了 `POST /api/kg/observations` 处理重复内容的逻辑。
*   详细说明了 `PUT /api/kg/entity` 同时处理类型更新和重命名的功能。
*   精确描述了 `PUT /api/kg/relation` 更改关系类型的具体行为。
*   明确了 `PUT /api/kg/relation-properties` 和 `PUT /api/kg/entity-properties` 是完全替换属性。
*   对所有 API 的参数（特别是必需/可选）和请求/响应体进行了校对。
*   重新编排了 API 序号。

这份修订后的文档现在应该能更准确地反映 `server.js` 和 `knowledge_graph.js` 中的实际 API 实现。